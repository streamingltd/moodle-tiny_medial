{"version":3,"file":"link.min.js","sources":["../src/link.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n// The max line length is set very low for nested code, so disable.\n/* eslint-disable max-len */\n\n/**\n * Link helper for Tiny Link plugin.\n *\n * @module      tiny_medial/link\n * @copyright   2023 Tim Williams, Streaming Ltd <tim@medial.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport Pending from 'core/pending';\nimport {getUserId, getOauthConsumerKey, getCourse, getPlayerSizeUrl, getBaseurl, getPlaceholder, getLinkOnly, getViewLaunchType, getBs5} from './options';\n\n/**\n * Handle insertion of a new medial video\n *\n * @param {int} preid\n * @param {String} inserttype\n * @param {TinyMCE} editor\n */\nexport const setLink = (preid, inserttype, editor) => {\n\n    var xmlDoc = new XMLHttpRequest();\n    var params = \"resource_link_id=\" + preid + \"&user_id=\" + getUserId(editor) +\n        \"&oauth_consumer_key=\" + getOauthConsumerKey(editor) +\n        \"&context_id=\" + getCourse(editor) +\n        \"&include_height=Y\";\n\n    xmlDoc.onload = (response) => {\n        const pendingPromise = new Pending('tiny_medial/setLink');\n        checkResponse(preid, inserttype, editor, response).then(pendingPromise.resolve).catch(error => {\n            /* eslint-disable-next-line no-console */\n            console.log(error);\n        });\n    };\n\n    xmlDoc.open(\"POST\", getPlayerSizeUrl(editor), true);\n    xmlDoc.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n    xmlDoc.send(params);\n};\n\n/**\n * Next step adding the tag to the editor\n *\n * @param {int} preid\n * @param {String} inserttype\n * @param {TinyMCE} editor\n * @param {Object} response\n */\nconst checkResponse = async(preid, inserttype, editor, response) => {\n    if (response.target.status < 200 && response.target.status >= 400) {\n        return;\n    }\n\n    var resp = response.target.responseText.split(':');\n\n    var audioonly = 0;\n    if (resp.length == 3 && resp[2] == 'Y') {\n        audioonly = 1;\n    }\n\n    setMedialLink(preid, inserttype, editor, audioonly, getViewLaunchType(editor), getTemplate(inserttype, editor), \"\", false);\n};\n\n/**\n * Handle insertion of a new medial video when we have content item return data\n *\n * @param {int} preid\n * @param {String} inserttype\n * @param {TinyMCE} editor\n * @param {object} data content item data\n */\nexport const setLinkCustom = (preid, inserttype, editor, data) => {\n    if (!('title' in data) || !('custom' in data) || !('audioonly' in data.custom)) {\n        /* eslint-disable no-console */\n        console.log(\"Bad message data\");\n        console.log(data);\n        /* eslint-enable no-console */\n        return;\n    }\n\n    // The custom data uses strings for everything becase the spec doesn't allow for other types.\n    var audioonly = 0;\n    if (data.custom.audioonly.toLowerCase() == \"true\") {\n        audioonly = 1;\n    }\n\n    setMedialLink(preid, inserttype, editor, audioonly, getViewLaunchType(editor), getTemplate(inserttype, editor),\n        data.title, data.custom.video_ref);\n};\n\n/**\n * Gets the template to use for the link generator\n *\n * @param {String} inserttype\n * @param {TinyMCE} editor\n * @return {String} The template name\n */\nconst getTemplate = (inserttype, editor) => {\n    if (getLinkOnly(editor) || inserttype != 'iframe') {\n        return 'tiny_medial/link';\n    }\n\n    return 'tiny_medial/iframe';\n};\n\n/**\n * Final step adding the tag to the editor\n *\n * @param {int} preid\n * @param {String} inserttype\n * @param {TinyMCE} editor\n * @param {int} audioonly\n * @param {int} launchtype\n * @param {String} template\n * @param {String} title\n * @param {String} videoref\n */\nexport const setMedialLink = async(preid, inserttype, editor, audioonly, launchtype, template, title, videoref) => {\n    var url = getEmbedUrl(editor) + \"?type=\" + launchtype + \"&responsive=1&medialembed=\" + inserttype + \"&audioonly=\" + audioonly + \"&l=\" + preid;\n    if (videoref) {\n        url += \"&video_ref=\" + videoref;\n    }\n    var context = {\n        url: url,\n        title: title,\n        bs5: getBs5(editor)\n    };\n\n    if (audioonly == 1) {\n        context.audioonly = true;\n    }\n\n    const {html} = await Templates.renderForPromise(template, context);\n    window.console.log(html);\n    editor.insertContent(html);\n};\n\n/**\n * Gets the base URL either with a placeholder of path at the front.\n * @param {TinyMCE} editor\n * @return url\n */\nconst getEmbedUrl = (editor) => {\n    if (getPlaceholder(editor) == 1) {\n        return \"{{{medial_launch_base}}}/mod/helixmedia/launch.php\";\n    } else {\n        return getBaseurl(editor) + \"/mod/helixmedia/launch.php\";\n    }\n};\n\n\n"],"names":["preid","inserttype","editor","xmlDoc","XMLHttpRequest","params","onload","response","pendingPromise","Pending","checkResponse","then","resolve","catch","error","console","log","open","setRequestHeader","send","async","target","status","resp","responseText","split","audioonly","length","setMedialLink","getTemplate","data","custom","toLowerCase","title","video_ref","launchtype","template","videoref","url","getEmbedUrl","context","bs5","html","Templates","renderForPromise","window","insertContent"],"mappings":";;;;;;;4OAqCuB,CAACA,MAAOC,WAAYC,cAEnCC,OAAS,IAAIC,eACbC,OAAS,oBAAsBL,MAAQ,aAAc,sBAAUE,QAC/D,wBAAyB,gCAAoBA,QAC7C,gBAAiB,sBAAUA,QAC3B,oBAEJC,OAAOG,OAAUC,iBACPC,eAAiB,IAAIC,iBAAQ,uBACnCC,cAAcV,MAAOC,WAAYC,OAAQK,UAAUI,KAAKH,eAAeI,SAASC,OAAMC,QAElFC,QAAQC,IAAIF,WAIpBX,OAAOc,KAAK,QAAQ,6BAAiBf,SAAS,GAC9CC,OAAOe,iBAAiB,eAAgB,qCACxCf,OAAOgB,KAAKd,eAWVK,cAAgBU,MAAMpB,MAAOC,WAAYC,OAAQK,iBAC/CA,SAASc,OAAOC,OAAS,KAAOf,SAASc,OAAOC,QAAU,UAI1DC,KAAOhB,SAASc,OAAOG,aAAaC,MAAM,KAE1CC,UAAY,EACG,GAAfH,KAAKI,QAA0B,KAAXJ,KAAK,KACzBG,UAAY,GAGhBE,cAAc5B,MAAOC,WAAYC,OAAQwB,WAAW,8BAAkBxB,QAAS2B,YAAY5B,WAAYC,QAAS,IAAI,4BAW3F,CAACF,MAAOC,WAAYC,OAAQ4B,aAC/C,UAAWA,SAAW,WAAYA,SAAW,cAAeA,KAAKC,eAEnEhB,QAAQC,IAAI,yBACZD,QAAQC,IAAIc,UAMZJ,UAAY,EAC2B,QAAvCI,KAAKC,OAAOL,UAAUM,gBACtBN,UAAY,GAGhBE,cAAc5B,MAAOC,WAAYC,OAAQwB,WAAW,8BAAkBxB,QAAS2B,YAAY5B,WAAYC,QACnG4B,KAAKG,MAAOH,KAAKC,OAAOG,kBAU1BL,YAAc,CAAC5B,WAAYC,UACzB,wBAAYA,SAAyB,UAAdD,WAChB,mBAGJ,qBAeE2B,cAAgBR,MAAMpB,MAAOC,WAAYC,OAAQwB,UAAWS,WAAYC,SAAUH,MAAOI,gBAC9FC,IAAMC,YAAYrC,QAAU,SAAWiC,WAAa,6BAA+BlC,WAAa,cAAgByB,UAAY,MAAQ1B,MACpIqC,WACAC,KAAO,cAAgBD,cAEvBG,QAAU,CACVF,IAAKA,IACLL,MAAOA,MACPQ,KAAK,mBAAOvC,SAGC,GAAbwB,YACAc,QAAQd,WAAY,SAGlBgB,KAACA,YAAcC,mBAAUC,iBAAiBR,SAAUI,SAC1DK,OAAO9B,QAAQC,IAAI0B,MACnBxC,OAAO4C,cAAcJ,kDAQnBH,YAAerC,QACa,IAA1B,2BAAeA,QACR,sDAEA,uBAAWA,QAAU"}